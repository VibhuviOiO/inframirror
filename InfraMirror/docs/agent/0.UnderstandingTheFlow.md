# Understanding Agent Registration Flow

## The Big Picture

### Who Does What?

```
┌─────────────────────────────────────────────────────────────────┐
│                         ADMIN (via UI)                          │
│                                                                 │
│  1. Creates API Key                                            │
│  2. Gets installation instructions                             │
│  3. That's it! No manual agent creation needed                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ Gives API key to
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      AGENT (Go binary)                          │
│                                                                 │
│  1. Reads config file (with API key)                           │
│  2. Collects own metadata (hostname, IP, OS)                   │
│  3. Calls /api/agents/register                                 │
│  4. Receives agentId                                            │
│  5. Starts monitoring                                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ Sends registration request
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BACKEND (Spring Boot)                        │
│                                                                 │
│  1. Validates API key                                          │
│  2. Auto-creates Region (from tags)                            │
│  3. Auto-creates Datacenter (from tags)                        │
│  4. Auto-creates Agent entity                                  │
│  5. Returns agentId                                             │
└─────────────────────────────────────────────────────────────────┘
```

---

## Detailed Flow

### Step 1: Admin Creates API Key (UI Only)

**What Admin Does**:
```
1. Login to UI
2. Navigate to Settings → API Keys
3. Click "Create API Key"
4. Enter name: "Production Agent Key"
5. Click Save
6. Copy the generated key: "abc123xyz789"
```

**What Gets Created in Database**:
```sql
INSERT INTO api_key (name, key_value, is_active)
VALUES ('Production Agent Key', 'abc123xyz789', true);
```

**That's it!** Admin doesn't create:
- ❌ Region (agent creates it)
- ❌ Datacenter (agent creates it)
- ❌ Agent entity (agent creates it)

---

### Step 2: Admin Deploys Agent Binary

**What Admin Does**:
```bash
# 1. Download agent binary
wget https://releases.inframirror.com/agent-linux-amd64

# 2. Create config file
cat > agent-config.yml <<EOF
api:
  url: "https://inframirror.example.com"
  key: "abc123xyz789"  # From Step 1

agent:
  name: "agent-aws-us-east-1"
  tags:
    region: "AWS US East"
    datacenter: "Virginia DC1"
    environment: "production"
EOF

# 3. Run agent
./agent-linux-amd64 --config agent-config.yml
```

**That's it!** Admin doesn't need to:
- ❌ Create agent in UI
- ❌ Create region in UI
- ❌ Create datacenter in UI

---

### Step 3: Agent Self-Registers (Automatic)

**What Agent Does on Startup**:

```go
// 1. Read config
config := loadConfig("agent-config.yml")

// 2. Collect own metadata
metadata := AgentMetadata{
    Name:         config.Agent.Name,           // "agent-aws-us-east-1"
    Hostname:     os.Hostname(),               // "ip-10-0-1-5.ec2.internal"
    IPAddress:    getLocalIP(),                // "10.0.1.5"
    OSType:       runtime.GOOS,                // "linux"
    OSVersion:    getOSVersion(),              // "Ubuntu 22.04"
    AgentVersion: "1.0.0",
    Tags:         config.Agent.Tags,
}

// 3. Call registration API
response := httpClient.Post("/api/agents/register", metadata)

// 4. Save agentId locally
saveAgentID(response.AgentId)  // Save to disk: ~/.inframirror/agent-id

// 5. Start monitoring
startMonitoring(response.AgentId)
```

**What Backend Does**:

```java
@PostMapping("/api/agents/register")
public ResponseEntity<AgentRegistrationResponseDTO> registerAgent(
    @RequestHeader("X-API-Key") String apiKey,
    @RequestBody AgentRegistrationRequestDTO request
) {
    // 1. Validate API key
    if (!apiKeyService.isValid(apiKey)) {
        return 401 Unauthorized;
    }
    
    // 2. Extract region/datacenter from tags
    String regionName = request.getTags().get("region");      // "AWS US East"
    String datacenterName = request.getTags().get("datacenter"); // "Virginia DC1"
    
    // 3. Find or create Region
    Region region = regionRepository.findByName(regionName)
        .orElseGet(() -> {
            Region newRegion = new Region();
            newRegion.setName(regionName);
            return regionRepository.save(newRegion);
        });
    
    // 4. Find or create Datacenter
    Datacenter datacenter = datacenterRepository.findByNameAndRegionId(datacenterName, region.getId())
        .orElseGet(() -> {
            Datacenter newDC = new Datacenter();
            newDC.setName(datacenterName);
            newDC.setRegion(region);
            return datacenterRepository.save(newDC);
        });
    
    // 5. Create Agent entity
    Agent agent = new Agent();
    agent.setName(request.getName());
    agent.setHostname(request.getHostname());
    agent.setIpAddress(request.getIpAddress());
    agent.setOsType(request.getOsType());
    agent.setOsVersion(request.getOsVersion());
    agent.setAgentVersion(request.getAgentVersion());
    agent.setTags(request.getTags());
    agent.setRegion(region);
    agent.setDatacenter(datacenter);
    agent.setStatus("ACTIVE");
    agent = agentRepository.save(agent);
    
    // 6. Return response
    return ResponseEntity.ok(new AgentRegistrationResponseDTO(
        agent.getId(),
        region,
        datacenter,
        "REGISTERED"
    ));
}
```

---

## What Gets Created Where?

### UI Creates (Manual)
```
✅ API Key only
```

### Agent Creates (Automatic via API)
```
✅ Region (if not exists)
✅ Datacenter (if not exists)
✅ Agent entity (always new)
```

### Backend Stores (Automatic)
```
✅ All agent metadata (hostname, IP, OS, version, tags)
✅ Relationships (agent → datacenter → region)
```

---

## Database State After Registration

### Before Agent Runs
```sql
-- Only API key exists
SELECT * FROM api_key;
-- id | name                  | key_value     | is_active
-- 1  | Production Agent Key  | abc123xyz789  | true

SELECT * FROM region;
-- Empty

SELECT * FROM datacenter;
-- Empty

SELECT * FROM agent;
-- Empty
```

### After Agent Registers
```sql
-- Region auto-created
SELECT * FROM region;
-- id | name
-- 1  | AWS US East

-- Datacenter auto-created
SELECT * FROM datacenter;
-- id | name          | region_id
-- 1  | Virginia DC1  | 1

-- Agent auto-created
SELECT * FROM agent;
-- id | name                | hostname              | ip_address | os_type | datacenter_id | region_id
-- 1  | agent-aws-us-east-1 | ip-10-0-1-5.ec2.internal | 10.0.1.5 | linux   | 1            | 1
```

---

## UI vs Agent Responsibilities

### UI Responsibilities
```
1. Create API Key
2. Display agent installation instructions
3. Show registered agents (read-only view)
4. Show regions/datacenters (read-only view)
```

**UI does NOT**:
- ❌ Create agents manually
- ❌ Create regions manually
- ❌ Create datacenters manually
- ❌ Update agent metadata (agent updates itself)

### Agent Responsibilities
```
1. Read config file
2. Collect own metadata
3. Register itself via API
4. Discover infrastructure
5. Submit heartbeats
6. Update lastSeenAt timestamp
```

**Agent does NOT**:
- ❌ Need UI interaction after getting API key
- ❌ Need manual configuration of region/datacenter in backend

---

## Example: Multiple Agents

### Scenario: 3 Agents in 2 Datacenters

**Admin does once**:
```
1. Create API key: "abc123xyz789"
2. Deploy 3 agents with same API key
```

**Agent 1 config**:
```yaml
api:
  key: "abc123xyz789"
agent:
  name: "agent-aws-us-east-1"
  tags:
    region: "AWS US East"
    datacenter: "Virginia DC1"
```

**Agent 2 config**:
```yaml
api:
  key: "abc123xyz789"
agent:
  name: "agent-aws-us-west-1"
  tags:
    region: "AWS US West"
    datacenter: "Oregon DC1"
```

**Agent 3 config** (HA backup in same DC):
```yaml
api:
  key: "abc123xyz789"
agent:
  name: "agent-aws-us-east-1-backup"
  tags:
    region: "AWS US East"
    datacenter: "Virginia DC1"
    ha_mode: "active-passive"
```

**Result in Database**:
```sql
-- 2 Regions auto-created
SELECT * FROM region;
-- id | name
-- 1  | AWS US East
-- 2  | AWS US West

-- 2 Datacenters auto-created
SELECT * FROM datacenter;
-- id | name          | region_id
-- 1  | Virginia DC1  | 1
-- 2  | Oregon DC1    | 2

-- 3 Agents auto-created
SELECT * FROM agent;
-- id | name                        | datacenter_id
-- 1  | agent-aws-us-east-1         | 1
-- 2  | agent-aws-us-west-1         | 2
-- 3  | agent-aws-us-east-1-backup  | 1  (same datacenter for HA)
```

---

## Summary

### Admin's Job (UI)
```
1. Create API Key ✅
2. Copy API key
3. Deploy agent binary with config
4. Done! ✅
```

### Agent's Job (Automatic)
```
1. Read config ✅
2. Collect metadata ✅
3. Register via API ✅
4. Create Region/Datacenter/Agent ✅
5. Start monitoring ✅
```

### Backend's Job (Automatic)
```
1. Validate API key ✅
2. Auto-create Region ✅
3. Auto-create Datacenter ✅
4. Auto-create Agent ✅
5. Store all metadata ✅
```

---

## Key Takeaway

**Zero Manual Configuration!**

Admin only creates API key. Everything else is automatic:
- ✅ Agent registers itself
- ✅ Region created automatically
- ✅ Datacenter created automatically
- ✅ Agent entity created automatically
- ✅ All metadata stored automatically

This is the **Datadog model**: Deploy agent → It registers itself → Start monitoring!
