# Step 2: Create Agent Registration API

## Goal
Create dedicated API endpoint for agent self-registration using single API key.

## API Design

### Endpoint
```
POST /api/agents/register
```

### Authentication
```
X-API-Key: {api-key-from-ui}
```

**Note**: Single API key for all operations (no MASTER/AGENT distinction)

### Request
```json
{
  "name": "agent-aws-us-east-1",
  "hostname": "ip-10-0-1-5.ec2.internal",
  "ipAddress": "10.0.1.5",
  "osType": "Linux",
  "osVersion": "Ubuntu 22.04",
  "agentVersion": "1.0.0",
  "tags": {
    "region": "AWS US East",
    "datacenter": "Virginia DC1",
    "environment": "production"
  }
}
```

### Response
```json
{
  "agentId": 123,
  "region": {
    "id": 1,
    "name": "AWS US East"
  },
  "datacenter": {
    "id": 5,
    "name": "Virginia DC1"
  },
  "status": "REGISTERED",
  "message": "Agent registered successfully"
}
```

## Implementation

### Files to Create

1. **AgentRegistrationRequestDTO.java** ✅ (Already created)
2. **AgentRegistrationResponseDTO.java** ✅ (Already created)
3. **AgentRegistrationService.java** ✅ (Already created)
4. **AgentRegistrationServiceImpl.java** ✅ (Already created)
5. **AgentRegistrationResource.java** (Need to create)

### AgentRegistrationResource.java

```java
package vibhuvi.oio.inframirror.web.rest;

import jakarta.validation.Valid;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import vibhuvi.oio.inframirror.service.AgentRegistrationService;
import vibhuvi.oio.inframirror.service.ApiKeyService;
import vibhuvi.oio.inframirror.service.dto.AgentRegistrationRequestDTO;
import vibhuvi.oio.inframirror.service.dto.AgentRegistrationResponseDTO;
import vibhuvi.oio.inframirror.web.rest.errors.BadRequestAlertException;

/**
 * REST controller for agent self-registration.
 */
@RestController
@RequestMapping("/api/agents")
public class AgentRegistrationResource {

    private static final Logger LOG = LoggerFactory.getLogger(AgentRegistrationResource.class);

    private final AgentRegistrationService agentRegistrationService;
    private final ApiKeyService apiKeyService;

    public AgentRegistrationResource(
        AgentRegistrationService agentRegistrationService,
        ApiKeyService apiKeyService
    ) {
        this.agentRegistrationService = agentRegistrationService;
        this.apiKeyService = apiKeyService;
    }

    /**
     * POST /api/agents/register : Register a new agent.
     *
     * @param apiKey the API key from header
     * @param request the agent registration request
     * @return the ResponseEntity with status 200 (OK) and registration response
     */
    @PostMapping("/register")
    public ResponseEntity<AgentRegistrationResponseDTO> registerAgent(
        @RequestHeader("X-API-Key") String apiKey,
        @Valid @RequestBody AgentRegistrationRequestDTO request
    ) {
        LOG.debug("REST request to register agent: {}", request.getName());

        // Validate API key
        if (!apiKeyService.isValidApiKey(apiKey)) {
            throw new BadRequestAlertException("Invalid API key", "agent", "invalidapikey");
        }

        // Register agent
        AgentRegistrationResponseDTO response = agentRegistrationService.registerAgent(request);

        return ResponseEntity.ok(response);
    }
}
```

### Update SecurityConfiguration

**File**: `src/main/java/vibhuvi/oio/inframirror/config/SecurityConfiguration.java`

```java
// Add to permitAll list
.requestMatchers("/api/agents/register").permitAll()
```

### Add API Key Validation to ApiKeyService

**File**: `src/main/java/vibhuvi/oio/inframirror/service/ApiKeyService.java`

```java
/**
 * Check if API key is valid and active.
 *
 * @param keyValue the API key value
 * @return true if valid, false otherwise
 */
boolean isValidApiKey(String keyValue);
```

**File**: `src/main/java/vibhuvi/oio/inframirror/service/impl/ApiKeyServiceImpl.java`

```java
@Override
public boolean isValidApiKey(String keyValue) {
    return apiKeyRepository
        .findByKeyValue(keyValue)
        .map(apiKey -> apiKey.getIsActive() && 
                      (apiKey.getExpiresAt() == null || apiKey.getExpiresAt().isAfter(Instant.now())))
        .orElse(false);
}
```

### Add Repository Method

**File**: `src/main/java/vibhuvi/oio/inframirror/repository/ApiKeyRepository.java`

```java
Optional<ApiKey> findByKeyValue(String keyValue);
```

## Testing with cURL

### Test 1: Successful Registration

```bash
# 1. Get API key from UI
# Navigate to: Settings → API Keys → Create new key
# Copy key value: abc123xyz789

# 2. Register agent
curl -X POST http://localhost:8080/api/agents/register \
  -H "X-API-Key: abc123xyz789" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "agent-test-1",
    "hostname": "test-host.local",
    "ipAddress": "10.0.1.5",
    "osType": "Linux",
    "osVersion": "Ubuntu 22.04",
    "agentVersion": "1.0.0",
    "tags": {
      "region": "Test Region",
      "datacenter": "Test DC",
      "environment": "dev"
    }
  }'

# Expected response:
{
  "agentId": 1,
  "region": {
    "id": 1,
    "name": "Test Region"
  },
  "datacenter": {
    "id": 1,
    "name": "Test DC"
  },
  "status": "REGISTERED",
  "message": "Agent registered successfully"
}
```

### Test 2: Verify Auto-Creation

```bash
# Check database
docker exec -it inframirror-postgres psql -U inframirror -d inframirror

# Verify region created
SELECT * FROM region WHERE name = 'Test Region';

# Verify datacenter created
SELECT * FROM datacenter WHERE name = 'Test DC';

# Verify agent created
SELECT * FROM agent WHERE name = 'agent-test-1';

# Check all agent fields
SELECT id, name, hostname, ip_address, os_type, agent_version, status, tags 
FROM agent WHERE name = 'agent-test-1';
```

### Test 3: Invalid API Key

```bash
curl -X POST http://localhost:8080/api/agents/register \
  -H "X-API-Key: invalid-key" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "agent-test-2",
    "hostname": "test-host-2",
    "ipAddress": "10.0.1.6",
    "osType": "Linux",
    "agentVersion": "1.0.0",
    "tags": {
      "region": "Test Region",
      "datacenter": "Test DC"
    }
  }'

# Expected: 400 Bad Request
# Message: "Invalid API key"
```

### Test 4: Missing Required Fields

```bash
curl -X POST http://localhost:8080/api/agents/register \
  -H "X-API-Key: abc123xyz789" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "agent-test-3",
    "hostname": "test-host-3"
  }'

# Expected: 400 Bad Request
# Validation errors for missing fields
```

### Test 5: Multiple Agents in Same Datacenter (HA)

```bash
# Register first agent
curl -X POST http://localhost:8080/api/agents/register \
  -H "X-API-Key: abc123xyz789" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "agent-dc1-primary",
    "hostname": "host-1",
    "ipAddress": "10.0.1.10",
    "osType": "Linux",
    "agentVersion": "1.0.0",
    "tags": {
      "region": "US East",
      "datacenter": "DC1",
      "ha_mode": "active-passive",
      "ha_group": "dc1-ha"
    }
  }'

# Register second agent (same datacenter)
curl -X POST http://localhost:8080/api/agents/register \
  -H "X-API-Key: abc123xyz789" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "agent-dc1-backup",
    "hostname": "host-2",
    "ipAddress": "10.0.1.11",
    "osType": "Linux",
    "agentVersion": "1.0.0",
    "tags": {
      "region": "US East",
      "datacenter": "DC1",
      "ha_mode": "active-passive",
      "ha_group": "dc1-ha"
    }
  }'

# Both should succeed - same datacenter, different names
```

## Validation

### Database Verification

```sql
-- Check agents in same datacenter
SELECT a.id, a.name, a.hostname, a.status, d.name as datacenter
FROM agent a
JOIN datacenter d ON a.datacenter_id = d.id
WHERE d.name = 'DC1';

-- Check agent tags
SELECT name, tags FROM agent WHERE name LIKE 'agent-dc1-%';
```

### UI Verification

```bash
# Navigate to: http://localhost:8080/agent
# Verify both agents appear
# Check datacenter relationship
# Verify tags are displayed
```

## Integration Test

```java
@SpringBootTest
@AutoConfigureMockMvc
class AgentRegistrationResourceIT {
    
    @Autowired
    private MockMvc restMockMvc;
    
    @Autowired
    private ObjectMapper om;
    
    @Autowired
    private ApiKeyRepository apiKeyRepository;
    
    private String validApiKey;
    
    @BeforeEach
    void setup() {
        // Create valid API key
        ApiKey apiKey = new ApiKey();
        apiKey.setName("Test Key");
        apiKey.setKeyValue("test-key-123");
        apiKey.setIsActive(true);
        apiKeyRepository.save(apiKey);
        validApiKey = "test-key-123";
    }
    
    @Test
    @Transactional
    void testAgentRegistration() throws Exception {
        AgentRegistrationRequestDTO request = new AgentRegistrationRequestDTO();
        request.setName("test-agent");
        request.setHostname("test-host");
        request.setIpAddress("10.0.1.5");
        request.setOsType("Linux");
        request.setAgentVersion("1.0.0");
        request.setTags(Map.of(
            "region", "Test Region",
            "datacenter", "Test DC"
        ));
        
        restMockMvc.perform(
            post("/api/agents/register")
                .header("X-API-Key", validApiKey)
                .contentType(MediaType.APPLICATION_JSON)
                .content(om.writeValueAsBytes(request))
        )
        .andExpect(status().isOk())
        .andExpect(jsonPath("$.agentId").exists())
        .andExpect(jsonPath("$.status").value("REGISTERED"))
        .andExpect(jsonPath("$.region.name").value("Test Region"))
        .andExpect(jsonPath("$.datacenter.name").value("Test DC"));
    }
    
    @Test
    void testInvalidApiKey() throws Exception {
        AgentRegistrationRequestDTO request = new AgentRegistrationRequestDTO();
        request.setName("test-agent");
        request.setHostname("test-host");
        request.setIpAddress("10.0.1.5");
        request.setOsType("Linux");
        request.setAgentVersion("1.0.0");
        request.setTags(Map.of("region", "Test", "datacenter", "Test"));
        
        restMockMvc.perform(
            post("/api/agents/register")
                .header("X-API-Key", "invalid-key")
                .contentType(MediaType.APPLICATION_JSON)
                .content(om.writeValueAsBytes(request))
        )
        .andExpect(status().isBadRequest());
    }
}
```

## Acceptance Criteria

- [ ] POST /api/agents/register endpoint works
- [ ] API key validation works (single key for all)
- [ ] Region auto-created if not exists
- [ ] Datacenter auto-created if not exists
- [ ] Agent entity created with all fields from request
- [ ] Tags stored as JSONB
- [ ] Multiple agents can register in same datacenter
- [ ] Invalid API key returns 400
- [ ] Missing required fields returns 400
- [ ] Integration tests pass
- [ ] cURL tests work

## Next Steps

Once registration API is ready:
→ **Step 3**: Create Infrastructure Reporting API
→ **Step 4**: Create Batch Heartbeat Ingestion API
→ **Step 5**: Build Go agent

## Notes

- **Single API Key**: No MASTER/AGENT distinction needed
- **Simple Validation**: Just check if key exists and is active
- **HA Support**: Multiple agents per datacenter allowed
- **Auto-Creation**: Region/Datacenter created automatically
- **Validation from UI**: Backend just stores data
